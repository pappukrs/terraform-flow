name: Infrastructure Bootstrap

on:
  workflow_dispatch:
    inputs:
      bucket_suffix:
        description: 'Unique suffix for S3 bucket (e.g., yourname-2026)'
        required: true
        default: 'tf-state-2026'
      confirm:
        description: 'Type "bootstrap" to create S3 bucket and DynamoDB table'
        required: true
        default: ''

env:
  AWS_REGION: ap-south-1
  PROJECT_NAME: demo-app

jobs:
  bootstrap:
    name: Create State Backend
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'bootstrap' }}

    env:
      BUCKET_NAME: ${{ github.event.inputs.bucket_suffix }}-terraform-state
      TABLE_NAME: demo-app-terraform-locks

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 bucket for state
        run: |
          aws s3api create-bucket \
            --bucket ${{ env.BUCKET_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }} || true
          
          aws s3api put-bucket-versioning \
            --bucket ${{ env.BUCKET_NAME }} \
            --versioning-configuration Status=Enabled
          
          aws s3api put-bucket-encryption \
            --bucket ${{ env.BUCKET_NAME }} \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'

      - name: Create DynamoDB table for locking
        run: |
          aws dynamodb create-table \
            --table-name ${{ env.TABLE_NAME }} \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ env.AWS_REGION }} || true

      - name: Summary
        run: |
          echo "## Bootstrap Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`${{ env.BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**DynamoDB Table:** \`${{ env.TABLE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **IMPORTANT:** Update \`infra/backend.tf\` with this bucket name:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`hcl" >> $GITHUB_STEP_SUMMARY
          echo "bucket = \"${{ env.BUCKET_NAME }}\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
