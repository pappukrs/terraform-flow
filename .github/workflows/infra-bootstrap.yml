name: Infrastructure Bootstrap

on:
  workflow_dispatch:
    inputs:
      bucket_suffix:
        description: 'Unique suffix for S3 bucket (e.g., yourname-2026)'
        required: true
        default: 'tf-state-2026'
      confirm:
        description: 'Type "bootstrap" to create S3 bucket, DynamoDB table, and ECR repository'
        required: true
        default: ''

env:
  AWS_REGION: ap-south-1
  PROJECT_NAME: demo-app

jobs:
  bootstrap:
    name: Create State Backend and ECR
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'bootstrap' }}
    permissions:
      contents: write  # SQL: Required to push changes to backend.tf

    env:
      BUCKET_NAME: ${{ github.event.inputs.bucket_suffix }}-terraform-state
      TABLE_NAME: demo-app-terraform-locks
      ECR_REPO_NAME: demo-app

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Explicitly use token for push

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 bucket for state
        run: |
          aws s3api create-bucket \
            --bucket ${{ env.BUCKET_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }} || true
          
          aws s3api put-bucket-versioning \
            --bucket ${{ env.BUCKET_NAME }} \
            --versioning-configuration Status=Enabled
          
          aws s3api put-bucket-encryption \
            --bucket ${{ env.BUCKET_NAME }} \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'

      - name: Create DynamoDB table for locking
        run: |
          aws dynamodb create-table \
            --table-name ${{ env.TABLE_NAME }} \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ env.AWS_REGION }} || true

      - name: Create ECR repository
        run: |
          aws ecr create-repository \
            --repository-name ${{ env.ECR_REPO_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true || true

      - name: Get ECR repository URL
        id: ecr_url
        run: |
          ECR_URL=$(aws ecr describe-repositories \
            --repository-names ${{ env.ECR_REPO_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo "ecr_url=$ECR_URL" >> $GITHUB_OUTPUT

      - name: Update backend.tf automatically
        run: |
          # Use sed to replace the placeholder or the existing bucket name
          # We look for bucket = "..."
          sed -i 's/bucket *= *"[^"]*"/bucket         = "${{ env.BUCKET_NAME }}"/' infra/backend.tf
          
          # Show the change
          cat infra/backend.tf

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add infra/backend.tf
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to backend.tf"
          else
            git commit -m "chore: auto-update terraform backend bucket to ${{ env.BUCKET_NAME }}"
            git push origin HEAD:${{ github.ref }}
            echo "âœ… Successfully updated backend.tf in the repository!"
          fi

      - name: Summary
        run: |
          echo "## Bootstrap Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`${{ env.BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**DynamoDB Table:** \`${{ env.TABLE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Repository:** \`${{ steps.ecr_url.outputs.ecr_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **backend.tf has been automatically updated!**" >> $GITHUB_STEP_SUMMARY
          echo "You can now proceed to run the 'Infrastructure Up' workflow." >> $GITHUB_STEP_SUMMARY
